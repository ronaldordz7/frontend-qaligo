<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Q'aliGo | Checkout</title>

  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="assets/css/layout.css">
  <link rel="stylesheet" href="assets/css/components.css">
  <link rel="stylesheet" href="assets/css/pages.css">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body>

<header class="navbar glass">
  <h2 onclick="location.href='index.html'" style="cursor:pointer;">Q'aliGo</h2>

  <nav>
    <a href="index.html">Menú</a>
    <a href="perfil.html">Mi Cuenta</a>
  </nav>

  <button class="btn" onclick="location.href='login.html'">Iniciar sesión</button>
</header>

<main class="container">
  
  <h2 class="page-title">Finalizar compra</h2>

  <div id="checkout-container" class="glass" style="padding:22px;">
    <!-- contenido dinámico -->
  </div>

</main>

<script type="module">
import { getCart, totalPrice, clearCart } from "./assets/js/cart.js";
import { apiPost } from "./assets/js/api.js";

const container = document.getElementById("checkout-container");

// Verificar login
const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user") || "null");

if (!token || !user) {
  container.innerHTML = `
    <p style="margin-bottom:16px;">Debes iniciar sesión para continuar</p>
    <button class="btn" onclick="location.href='login.html'">Iniciar sesión</button>
  `;
} else {
  renderCheckout();
}

function renderCheckout() {
  const cart = getCart();

  if (cart.length === 0) {
    container.innerHTML = "<p>Tu carrito está vacío.</p>";
    return;
  }

  const total = totalPrice();

  container.innerHTML = `
    <h3>Datos personales</h3>
    <div style="margin-bottom:18px;">
      <input id="name" class="glass" style="padding:10px;width:100%;margin-top:6px;" placeholder="Nombre completo" value="${user.name}">
      <input id="phone" class="glass" style="padding:10px;width:100%;margin-top:6px;" placeholder="Teléfono">
      <input id="address" class="glass" style="padding:10px;width:100%;margin-top:6px;" placeholder="Dirección de entrega">
    </div>

    <h3>Tu pedido</h3>
    <div id="order-items" style="margin:12px 0;"></div>

    <h3>Total</h3>
    <p><b>S/ ${total.toFixed(2)}</b></p>

    <h3 style="margin-top:18px;">Datos de pago</h3>
    <div>
      <input class="glass" id="card" placeholder="Número de tarjeta" style="padding:8px;width:100%;margin-top:6px;">
      <input class="glass" id="exp" placeholder="MM/YY" style="padding:8px;width:48%;margin-top:6px;">
      <input class="glass" id="cvv" placeholder="CVV" style="padding:8px;width:48%;margin-top:6px;float:right;">
    </div>

    <button id="pay-btn" class="btn" style="margin-top:24px;width:100%;">Pagar ahora</button>
  `;

  const list = document.getElementById("order-items");

  list.innerHTML = cart
    .map(
      item => `
    <div class="glass" style="padding:12px;margin-bottom:10px;">
      <h4>${item.name}</h4>
      <p style="opacity:0.7;">Cantidad: ${item.quantity}</p>
      <p style="opacity:0.7;">Sub: S/ ${(item.unitPrice * item.quantity).toFixed(2)}</p>
    </div>`
    )
    .join("");

  document.getElementById("pay-btn").onclick = submitOrder;
}

// ========================
// ENVIAR ORDEN AL BACKEND
// ========================
async function submitOrder() {
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const address = document.getElementById("address").value.trim();

  if (!name || !phone || !address) {
    alert("Completa todos los datos personales.");
    return;
  }

  const items = getCart().map(item => ({
    productId: item.productId,
    quantity: item.quantity,
    unitPrice: item.unitPrice,
    customizationJson: item.customizationJson
  }));

  const body = {
    items,
    customerName: name,
    customerPhone: phone,
    customerAddress: address
  };

  const res = await apiPost("/orders", body, true);

  if (res.error) {
    alert("Error: " + res.error);
    return;
  }

  clearCart();
  window.location.href = "confirmacion.html";
}
</script>

</body>
</html>
