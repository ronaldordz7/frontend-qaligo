<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Q'aliGo | Administrador</title>

  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="assets/css/components.css">
  <link rel="stylesheet" href="assets/css/layout.css">
  <link rel="stylesheet" href="assets/css/pages.css">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    .admin-box {
      max-width: 900px;
      margin: 40px auto;
      padding: 30px;
      animation: fadeIn 0.5s ease;
    }

    .order-card {
      padding: 16px;
      margin-top: 14px;
      border-radius: 14px;
    }

    .order-items {
      margin-top: 10px;
      padding-left: 18px;
      opacity: 0.9;
    }

    .logout-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.4);
      color: white;
      margin-top: 20px;
      width: 100%;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>

<header class="navbar glass">
  <h2 onclick="location.href='index.html'" style="cursor:pointer;">Q'aliGo</h2>

  <nav>
    <a href="index.html">Menú</a>
    <a href="perfil.html">Mi Cuenta</a>
    <a href="admin.html" class="active">Admin</a>
  </nav>

  <button class="btn" onclick="location.href='login.html'">Iniciar sesión</button>
</header>


<main class="container">
  
  <div id="admin-box" class="admin-box glass">
    <!-- Contenido dinámico -->
  </div>

</main>


<script type="module">
import { apiGet } from "./assets/js/api.js";
import { logout } from "./assets/js/auth.js";

// Validar si el usuario es admin
const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user") || "null");

const box = document.getElementById("admin-box");

if (!token || !user) {
  box.innerHTML = `
    <p>Debes iniciar sesión como administrador.</p>
    <button class="btn" onclick="location.href='login.html'">Iniciar sesión</button>
  `;
} else if (user.role !== "ADMIN") {
  box.innerHTML = `
    <p>No tienes permisos para acceder a esta página.</p>
    <button class="btn" onclick="location.href='index.html'">Volver</button>
  `;
} else {
  loadDashboard();
}

async function loadDashboard() {
  box.innerHTML = "<p>Cargando pedidos...</p>";

  const orders = await apiGet("/admin/orders", true)
    .catch(() => null);

  if (!orders) {
    box.innerHTML = "<p>Error al cargar pedidos.</p>";
    return;
  }

  renderDashboard(orders);
}

function renderDashboard(orders) {
  box.innerHTML = `
    <h2>Panel de administrador</h2>
    <p style="opacity:0.8;">Revisión general de pedidos</p>

    <h3 style="margin-top:20px;">Pedidos recientes</h3>
    ${orders.length === 0 ? "<p>No hay pedidos registrados.</p>" : ""}

    <div id="orders-list"></div>

    <button class="btn logout-btn" onclick="handleLogout()">Cerrar sesión</button>
  `;

  const list = document.getElementById("orders-list");

  orders.forEach(order => {
    const div = document.createElement("div");
    div.className = "order-card glass";

    const date = new Date(order.createdAt).toLocaleString();

    div.innerHTML = `
      <p><b>Pedido #${order.id}</b> — ${date}</p>
      <p>Cliente: ${order.customerName} (${order.user.email})</p>
      <p>Estado: ${order.status}</p>
      <p>Total: <b>S/ ${order.totalAmount.toFixed(2)}</b></p>

      <div class="order-items">
        ${order.items
          .map(
            item => `
            <p>• ProdID ${item.productId} — Cant: ${item.quantity} — S/ ${item.unitPrice.toFixed(
              2
            )}</p>
          `
          )
          .join("")}
      </div>
    `;

    list.appendChild(div);
  });
}

window.handleLogout = () => {
  logout();
  window.location.href = "index.html";
};
</script>

</body>
</html>
